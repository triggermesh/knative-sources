# Copyright (c) 2020 TriggerMesh Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: ocimetricssources.sources.triggermesh.io
  labels:
    eventing.knative.dev/source: "true"
    duck.knative.dev/source: "true"
    knative.dev/crd-install: "true"
spec:
  group: sources.triggermesh.io
  scope: Namespaced
  names:
    kind: OciMetricsSource
    plural: ocimetricssources
    categories:
      - all
      - knative
      - eventing
      - sources
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              description: Desired state of the event source.
              type: object
              properties:
                oracleApiPrivateKey:
                  type: object
                  description: PEM encoded API private key that has access to the OCI metrics API
                  properties:
                    secretKeyRef:
                      type: object
                      properties:
                        key:
                          type: string
                        name:
                          type: string
                oracleApiPrivateKeyPassphrase:
                  type: object
                  description: Passphrase to unlock the oracleApiPrivateKey
                  properties:
                    secretKeyRef:
                      type: object
                      properties:
                        key:
                          type: string
                        name:
                          type: string
                oracleApiPrivateKeyFingerprint:
                  type: object
                  description: md5 fingerprint of oracleApiPrivateKey
                  properties:
                    secretKeyRef:
                      type: object
                      properties:
                        key:
                          type: string
                        name:
                          type: string
                oracleTenancy:
                  description: OCID of the target tenancy
                  type: string
                oracleUser:
                  description: OCID of the target user associated with the oracleApiPrivateKey
                  type: string
                oracleRegion:
                  description: OCI target region
                  type: string
                metricsPollingFrequency:
                  description: Polling frequency of the OCI API for metrics details (supported values 1m-60m, 1h-24h, 1d)
                  type: string
                metricsNamespace:
                  description: Type of metrics to pull from such as oci_computeagent, oci_apigateway, oci_vnc, or oci_compute_infrastructure_health
                  type: string
                metricsQuery:
                  description: Metrics query to send based off of OCI Monitoring Query Language
                  type: string
                sink:
                  description: Reference to an event sink.
                  type: object
                  properties:
                    ref:
                      description: Reference of an Addressable object acting as event sink.
                      type: object
                      properties:
                        apiVersion:
                          description: API version of the referent.
                          type: string
                        kind:
                          description: Kind of the referent.
                          type: string
                        namespace:
                          description: Namespace of the referent.
                          type: string
                        name:
                          description: Name of the referent
                          type: string
                      required:
                        - apiVersion
                        - kind
                        - name
                    uri:
                      description: URI of the event sink.
                      type: string
                      format: uri
                  oneOf:
                    - required: ['ref']
                    - required: ['uri']
                ceOverrides:
                  description: Overrides for the attributes of CloudEvents generated by the
                    source.
                  type: object
                  properties:
                    extensions:
                      description: Map of CloudEvents attributes to be added or overridden.
                      type: object
                      additionalProperties:
                        type: string
                        minLength: 1
                  required:
                    - extensions
              required:
                - oracleApiPrivateKey
                - oracleApiPrivateKeyPassphrase
                - oracleApiPrivateKeyFingerprint
                - oracleTenancy
                - oracleUser
                - oracleRegion
                - metricsNamespace
                - metricsQuery
                - sink
            status:
              description: Status of the event source.
              type: object
              properties:
                sinkUri:
                  type: string
                  format: uri
                ceAttributes:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      source:
                        type: string
                    required:
                      - type
                      - source
                observedGeneration:
                  type: integer
                  format: int64
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: ['True', 'False', Unknown]
                      severity:
                        type: string
                        enum: [Error, Warning, Info]
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                    required:
                      - type
                      - status
      additionalPrinterColumns:
        - name: Ready
          type: string
          jsonPath: .status.conditions[?(@.type=='Ready')].status
        - name: Reason
          type: string
          jsonPath: .status.conditions[?(@.type=='Ready')].reason
        - name: URL
          type: string
          jsonPath: .status.address.url
        - name: Sink
          type: string
          jsonPath: .status.sinkUri
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

